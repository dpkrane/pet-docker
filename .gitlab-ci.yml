.build-image: &build-image
    - echo ${CI_REGISTRY_IMAGE}
    - echo ${CI_PROJECT_NAME}
    - echo ${CI_JOB_NAME##*_}
    - docker build --pull --tag=$IMAGE_TAGGED --tag=$IMAGE_LATEST --file=$DOCKERFILE  ${CI_JOB_NAME##*_}
    - docker push $IMAGE_TAGGED
    - docker push $IMAGE_LATEST

stages:
  - "build"
  - "deploy"

build_nginx:
  stage: build
  image: docker:stable
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    IMAGE_TAGGED: ${CI_REGISTRY_IMAGE}/${CI_PROJECT_NAME}/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHORT_SHA
    IMAGE_LATEST: $CI_REGISTRY_IMAGE/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:latest
    DOCKERFILE: "${CI_JOB_NAME##*_}/Dockerfile"
  services:
    - docker:dind
  before_script:
    - echo "$CI_JOB_TOKEN" | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
  script:
  - *build-image
  tags:
    - "docker"