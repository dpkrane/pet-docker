.build-image:
  stage: build
  image: docker:stable
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  services:
    - docker:dind
  before_script:
    - echo "$CI_JOB_TOKEN" | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
  script:
    - docker build --pull --tag=${CI_REGISTRY_IMAGE}/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHORT_SHA --tag=${CI_REGISTRY_IMAGE}/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:latest --file=${CI_JOB_NAME##*_}/Dockerfile  ${CI_JOB_NAME##*_}
    - docker push ${CI_REGISTRY_IMAGE}/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:$CI_COMMIT_SHORT_SHA
    - docker push ${CI_REGISTRY_IMAGE}/${CI_JOB_NAME##*_}-$CI_COMMIT_REF_SLUG:latest
  tags:
    - "docker"

stages:
  - "build"
  - "deploy"

build_nginx:
  extends: .build-image
